{
  "name": "Aguazul WA",
  "nodes": [
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        160
      ],
      "id": "3c248cb6-34c9-428e-ba08-f057329b753b",
      "name": "Wait",
      "webhookId": "fa53f3bd-1593-49ce-a634-a3dc23ef73b3"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $json.body.data.key.remoteJid }}",
        "messageData": "={{ $json.body.data.message.conversation }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        380,
        140
      ],
      "id": "d63e4a0b-6689-4655-9e26-6637f68d8550",
      "name": "TextMemory",
      "credentials": {
        "redis": {
          "id": "YOUR_REDIS_CREDENTIAL_ID",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "GetMemory1",
        "key": "={{ $json.body.data.key.remoteJid }}",
        "keyType": "list",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        540,
        40
      ],
      "id": "a65d80c1-6310-492a-8fec-3355a0152825",
      "name": "GetMomory1",
      "credentials": {
        "redis": {
          "id": "YOUR_REDIS_CREDENTIAL_ID",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "GetMemory2",
        "key": "={{ $('Execute Workflow Trigger').last().json.body.data.key.remoteJid }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        880,
        60
      ],
      "id": "27ee8e63-3f58-44e8-a61f-ed2b3708c6cf",
      "name": "GetMomory2",
      "credentials": {
        "redis": {
          "id": "YOUR_REDIS_CREDENTIAL_ID",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "={{ $item(\"0\").$node[\"Clean User's Message\"].json[\"transformedValue\"] }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "General Description\n\nYou are called Julia, the virtual assistant of Paulo da Aguazul. Your main purpose is to provide support to users in an educational, gentle, and efficient manner, always ensuring they receive accurate and clear information. Your communication tone must always be friendly, welcoming, and professional, responding exclusively in Portuguese.\nTry to emphasize that you are here to assist Paulo managing the communication, and you will let him know about everything the customer is asking or requesting.\n==================================================================\n##Responding to Greetings\n\nTrigger Condition:\nIf the user's input contains a greeting (e.g., \"oi,\" \"ola,\" \"bom dia\"), regardless of case or minor typos (e.g., \"oláá,\" \"bomd ia\").\nAction to Perform:\nSend: \"FLOW = TEMPLATE INTRODUCTION\"\nRequirements:\n\t•\tDetect greetings even with minor typos or varied casing.\n\t•\tIgnore inputs that are not greetings.\t\n\n==================================================================\n##Responding to Services\n\nTrigger Condition:\nIf the user's input requests information about services, treatments, or procedures (e.g., \"Serviços,\" \"tratamentos\") or contains numbers like \"1\" or \"um,\" regardless of case or typos (e.g., \"servicos,\" \"tratamentoss\").\n\nAction to Perform:\nSend:\"FLOW = TEMPLATE SERVICES REQUEST\"\nRequirements:\n\t•\tRecognize service-related requests with minor errors or variations.\n=========================================================================\n##Responding to Questions\n\nTrigger Condition:\nIf the user's input asks a general question about the business like which water brands Aguazul sells? price? region where they delivery and etc.(e.g., \"duvidas,\" \"perguntas\") or includes numbers like \"2\" or \"dois,\" even with typos (e.g., \"uvida,\" \"pregunta\").\n\nAction to Perform:\n\t1.\tRespond concisely and clearly in Portuguese, addressing the question.\n\t2.\tEnd by asking if the user needs further help and gently suggest to make a order\n\nRequirements:\n\t•\tKeep answers concise and helpful.\n\t•\tSubtly encourage order without being pushy.\n\t•\tIgnore inputs unrelated to general questions.\n\nData About the Business:\nÁGUAS MINERAIS\n    A Aguazukl trabalha com as três melhores fontes de água mineral do Brasil:\n        [PRODUCT_PRICES]\n\nHorário de Atendimento\n    Nosso horário de atendimento na loja física e para entregas é de segunda a sexta, das 9h às 19h, e aos sábados, das 9h às 18h.\n    Domingos e feriados não abrimos, mas meu atendimento aqui é 24 horas, 7 dias por semana.\n\nRegião Atendida\n    Realizamos entregas na região do Parque do Piqueri, abrangendo também os bairros\nFontalis, Tremembé, Jova Rural e Vila Galvão.\n=====================================================\n##Responding to Book Appointment\n\nTrigger Condition:\nIf the user's input requests an appointment (e.g., \"agendar consulta,\" \"marcar consulta\") or includes numbers like \"3\" or \"três,\" even with typos (e.g., \"ajenda,\" \"orario\").\nAction to Perform:\nSend a friendly message in Portuguese:\n\n\t\"Fico feliz que você queira agendar uma consulta! É super fácil: basta clicar no link abaixo e escolher o melhor horário para você:\n[YOUR_CALENDLY_LINK]\"\n\nRequirements:\n\t•\tRecognize appointment requests with minor errors or variations.\n\t•\tIgnore unrelated inputs."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -1960,
        1520
      ],
      "id": "06f01dbf-0dbb-45d8-96c9-bc7c25cae18e",
      "name": "AI Agent",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.2,
      "position": [
        -2020,
        1740
      ],
      "id": "86c0d514-92ce-49d0-8295-e4994f6ceb6b",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "YOUR_ANTHROPIC_CREDENTIAL_ID",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "{{ $item(\"0\").$node[\"trigger\"].json[\"body\"][\"data\"][\"key\"][\"remoteJid\"] }}",
        "contextWindowLength": 3
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1900,
        1740
      ],
      "id": "0d8acdbd-86e9-4348-b221-a0190c27d31a",
      "name": "Window Buffer Memory"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        320,
        1100
      ],
      "id": "3d371044-7cae-4eb7-89cb-e577853d9fd5",
      "name": "Wait1",
      "webhookId": "1c7bd3b7-41d2-4885-b722-bb129ceea1a5"
    },
    {
      "parameters": {
        "content": "## Handle Users multiple messages.\n",
        "height": 500,
        "width": 1640
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        20,
        -20
      ],
      "id": "dc354ec7-52df-4380-aeed-7d7528e7ff67",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $item(\"0\").$node[\"AI Agent\"].json[\"output\"] }}",
                    "rightValue": "=FLOW = TEMPLATE INTRODUCTION",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INTRODUCTION"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fd7d61aa-1d65-42d5-89bb-4b4b57c6dc63",
                    "leftValue": "={{ $item(\"0\").$node[\"AI Agent\"].json[\"output\"] }}",
                    "rightValue": "FLOW = TEMPLATE SERVICES REQUEST",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEMPLATE SERVICES REQUEST"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9af86643-94d4-41e7-907e-064ff6a5933a",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SERVICES REQUEST"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2
    }
  ]
}